<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- mark that JS is active so CSS can animate only when scripts run -->
  <script>document.documentElement.classList.add('js');</script>
  <title>{{player}} — {{set}} {{number}}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/styles.css?v=8" />

  <!-- Inline safety net so subgrades look right even if old CSS is cached -->
  <style>
    /* Heading on its own line */
    .grades h2{display:block;width:100%;margin:0 0 10px;line-height:1.2;}
    /* Two-column layout on wide screens */
    .grid-2{display:grid;grid-template-columns:1fr;gap:20px}
    @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}}
    /* Stacked subgrade rows: label/value above, full-width bar below */
    .subgrade{margin:12px 0}
    .subgrade-head{display:flex;justify-content:space-between;align-items:baseline;gap:12px}
    .subgrade-head .label{font-weight:700}
    .subgrade-head .value{font-weight:700;min-width:2ch;text-align:right}
    .subgrade .bar{width:100%;height:10px;background:var(--gray-200);border-radius:999px;overflow:hidden}
    .subgrade .bar>span{display:block;height:100%;width:0;background:var(--green);transition:width .6s ease}
    /* Overall circle has a default but we set it inline too */
    .circle{--angle:0%}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a href="/index.html" class="brand">
        <img src="/logo.png" alt="SLABMETRICS" class="logo" />
        <span>SLABMETRICS</span>
      </a>
    </div>
  </header>

  <!-- HERO -->
<section class="hero reveal is-visible">
  <div class="container hero-inner">

    <!-- Title + meta stay as-is -->
    <div class="hero-head">
      <h1 class="tight">
        <span class="dim">{{player}}</span>
        <span class="slash">—</span>
        {{set}} <span class="no-wrap">{{number}}</span>
      </h1>
      <p class="meta">
        <strong>Serial:</strong> {{serial}}
        <span class="dot">•</span>
        <strong>Graded:</strong> {{graded_at}}
        <span class="dot">•</span>
        <strong>Team:</strong> {{team}}
      </p>
    </div>

    <!-- NEW: Actions row = buttons (left) + overall circle (right) -->
    <div class="hero-actions">
      <div class="cta">
        <a class="btn btn-green" href="{{ebay}}" target="_blank" rel="noopener">View eBay Comps</a>
        <a class="btn" href="{{front_img}}" download="{{id}}-front.jpg">Download Front (JPG)</a>
        <a class="btn" href="{{back_img}}"  download="{{id}}-back.jpg">Download Back (JPG)</a>
      </div>

      <!-- Right column: circle + badge side-by-side -->
<div class="grade-side">
  <div class="overall" data-circle data-angle="{{overall_pct}}">
    <div class="circle" style="--angle: 0%">
      <div class="circle-inner">{{overall_grade}}</div>
    </div>
    <div class="circle-label">Overall</div>
  </div>

  </div>
</section>

  <!-- Flip Viewer -->

    <div class="container">
      <div class="flip-wrap" data-cardflip title="Click or tap to flip (←/→ also)">
        <img class="flip-img front" src="{{front_img}}" alt="{{player}} front" loading="lazy" />
        <img class="flip-img back"  src="{{back_img}}"  alt="{{player}} back"  loading="lazy" />
      </div>
      <p class="hint">Tip: tap/click to flip • ← / → keys work too</p>
    </div>
  </section>

  <!-- Subgrades (front + back) -->
  <section class="grades reveal">
    <div class="container grid-2">
      <!-- FRONT -->
      <div>
        <h2>Front Subgrades</h2>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Surface</div><div class="value">{{f_surface}}</div></div>
          <div class="bar"><span style="--pct: {{f_surface_pct}}%"></span></div>
        </div>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Centering</div><div class="value">{{f_centering}}</div></div>
          <div class="bar"><span style="--pct: {{f_centering_pct}}%"></span></div>
        </div>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Corners (avg)</div><div class="value">{{f_corners_avg}}</div></div>
          <div class="bar"><span style="--pct: {{f_corners_pct}}%"></span></div>
        </div>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Edges (avg)</div><div class="value">{{f_edges_avg}}</div></div>
          <div class="bar"><span style="--pct: {{f_edges_pct}}%"></span></div>
        </div>

        <div class="remarks">
          <div><strong>Surface:</strong> {{f_remarks_surface}}</div>
          <div><strong>Centering:</strong> {{f_remarks_centering}}</div>
          <div><strong>Corners:</strong> {{f_remarks_corners}}</div>
          <div><strong>Edges:</strong> {{f_remarks_edges}}</div>
        </div>
      </div>

      <!-- BACK -->
      <div>
        <h2>Back Subgrades</h2>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Surface</div><div class="value">{{b_surface}}</div></div>
          <div class="bar"><span style="--pct: {{b_surface_pct}}%"></span></div>
        </div>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Centering</div><div class="value">{{b_centering}}</div></div>
          <div class="bar"><span style="--pct: {{b_centering_pct}}%"></span></div>
        </div>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Corners (avg)</div><div class="value">{{b_corners_avg}}</div></div>
          <div class="bar"><span style="--pct: {{b_corners_pct}}%"></span></div>
        </div>

        <div class="subgrade">
          <div class="subgrade-head"><div class="label">Edges (avg)</div><div class="value">{{b_edges_avg}}</div></div>
          <div class="bar"><span style="--pct: {{b_edges_pct}}%"></span></div>
        </div>

        <div class="remarks">
          <div><strong>Surface:</strong> {{b_remarks_surface}}</div>
          <div><strong>Centering:</strong> {{b_remarks_centering}}</div>
          <div><strong>Corners:</strong> {{b_remarks_corners}}</div>
          <div><strong>Edges:</strong> {{b_remarks_edges}}</div>
        </div>
      </div>
    </div>
  </section>

  <!-- POP & GEM (replaces "How This Grade Compares") -->
<section class="pop-gem reveal" id="popGem">
  <div class="container">
    <h2>Big 4 Pop & Gem Rate</h2>
    <p class="fine">
      <strong>Pop</strong> = how many of this card each company has graded. 
      <strong>Gem Rate</strong> = share of those that earned the top grade 
      (PSA/SGC/CGC = 10; <span class="bgs-note">BGS “gem” is 9.5</span>).
    </p>

    <!-- Pop bars -->
    <div class="pop-bars" data-popbars>
      <!-- Each row needs just the pop number in your CSV -->
      <div class="pop-row" data-co="psa" data-pop="{{psa_pop||0}}">
        <div class="co"><span class="dot psa"></span>PSA</div>
        <div class="bar"><span></span></div>
        <div class="val" data-out>—</div>
      </div>

      <div class="pop-row" data-co="sgc" data-pop="{{sgc_pop||0}}">
        <div class="co"><span class="dot sgc"></span>SGC</div>
        <div class="bar"><span></span></div>
        <div class="val" data-out>—</div>
      </div>

      <div class="pop-row" data-co="cgc" data-pop="{{cgc_pop||0}}">
        <div class="co"><span class="dot cgc"></span>CGC</div>
        <div class="bar"><span></span></div>
        <div class="val" data-out>—</div>
      </div>

      <div class="pop-row" data-co="bgs" data-pop="{{bgs_pop||0}}">
        <div class="co"><span class="dot bgs"></span>Beckett</div>
        <div class="bar"><span></span></div>
        <div class="val" data-out>—</div>
      </div>
    </div>

    <!-- Gem rings -->
    <div class="gem-grid" data-gemrings>
      <!-- Each ring takes a % from your CSV (0–100). -->
      <div class="gem" data-co="psa" data-rate="{{psa_gem_rate||0}}">
        <div class="gem-ring" style="--angle: 0%">
          <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
        </div>
        <div class="gem-label"><span class="dot psa"></span>PSA Gem Rate</div>
      </div>

      <div class="gem" data-co="sgc" data-rate="{{sgc_gem_rate||0}}">
        <div class="gem-ring" style="--angle: 0%">
          <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
        </div>
        <div class="gem-label"><span class="dot sgc"></span>SGC Gem Rate</div>
      </div>

      <div class="gem" data-co="cgc" data-rate="{{cgc_gem_rate||0}}">
        <div class="gem-ring" style="--angle: 0%">
          <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
        </div>
        <div class="gem-label"><span class="dot cgc"></span>CGC Gem Rate</div>
      </div>

      <div class="gem" data-co="bgs" data-rate="{{bgs_gem_rate||0}}">
        <div class="gem-ring" style="--angle: 0%">
          <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
        </div>
        <div class="gem-label"><span class="dot bgs"></span>BGS Gem Rate</div>
      </div>
    </div>

    <p class="fine small-note">
      Note: BGS “gem” generally refers to **9.5**; PSA/SGC/CGC “gem” refers to **10**.
    </p>
  </div>
</section>

  <footer class="site-footer">
    <div class="container">
      <a class="btn" href="/index.html">← Back to All Cards</a>
    </div>
  </footer>

<script>

// ----- Helper: animate conic fill (--angle) smoothly everywhere -----
function animateCircleAngle(el, targetPct, duration = 900){
  if (!el) return;
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const startPct = parseFloat(getComputedStyle(el).getPropertyValue('--angle')) || 0;
  const endPct = Math.max(0, Math.min(100, targetPct));
  if (reduce) { el.style.setProperty('--angle', endPct + '%'); return; }

  const start = performance.now();
  const ease = t => 1 - Math.pow(1 - t, 3); // cubic ease-out

  function frame(now){
    const t = Math.min(1, (now - start) / duration);
    const k = ease(t);
    const v = startPct + (endPct - startPct) * k;
    el.style.setProperty('--angle', v.toFixed(2) + '%');
    if (t < 1) requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

// ----- Flip behavior -----
(function(){
  const root = document.querySelector('[data-cardflip]');
  if (!root) return;
  let flipped = false, startX = null;
  function setFlipped(v){ flipped=v; root.classList.toggle('flipped', flipped); }
  root.addEventListener('click', () => setFlipped(!flipped));
  root.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive:true});
  root.addEventListener('touchend', e => {
    if (startX==null) return;
    const dx = e.changedTouches[0].clientX - startX;
    if (Math.abs(dx) > 40) setFlipped(dx < 0);
    startX = null;
  }, {passive:true});
  root.tabIndex = 0;
  root.addEventListener('keydown', (e) => {
    if (e.key==='Enter'||e.key===' ') { e.preventDefault(); setFlipped(!flipped); }
    if (e.key==='ArrowLeft') setFlipped(true);
    if (e.key==='ArrowRight') setFlipped(false);
  });
})();

// ----- Reveal + animations (bars + circle) with safe fallback -----
(function(){
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const reveals = document.querySelectorAll('.reveal');

  // If IntersectionObserver isn't available, just show everything.
  if (!('IntersectionObserver' in window)) {
    reveals.forEach(el => el.classList.add('is-visible'));
  } else {
    const io = new IntersectionObserver((entries) => {
      entries.forEach((e) => {
        if (!e.isIntersecting) return;

        e.target.classList.add('is-visible');

        // Animate the overall circle (only the green fill)
        const box = e.target.querySelector?.('[data-circle]');
        const circ = box?.querySelector?.('.circle');
        if (!reduce && box && circ) {
          // Accept either 0–1 (e.g., 0.92) or 0–100 (e.g., 92)
          const raw = Number(box.dataset.angle || 0);
          const angle = raw <= 1 ? raw * 100 : raw;
          animateCircleAngle(circ, angle, 900);
        }
      });
    }, { threshold: 0.2 });
    reveals.forEach(el => io.observe(el));
  }

  // Animate grade bars
  document.querySelectorAll('.bar > span').forEach(s => {
    const m = (s.getAttribute('style') || '').match(/--pct:\s*([\d.]+)%/);
    const pct = m ? m[1] : '0';
    s.style.width = reduce ? pct + '%' : '0%';
    if (!reduce) requestAnimationFrame(() => { s.style.width = pct + '%'; });
  });
})();

// ----- Overall circle % (ensure it sets even if reduced motion) -----
(function(){
  const box = document.querySelector('[data-circle]');
  const circ = box?.querySelector?.('.circle');
  if (!box || !circ) return;
  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const raw = Number(box.dataset.angle || 0);
  const pct = raw <= 1 ? raw * 100 : raw;  // normalize 0–1 → 0–100
  if (reduce) circ.style.setProperty('--angle', pct + '%');
})();

// ----- Comparison chart (tolerant JSON parse) -----
(function(){
  let data = {};
  try { data = JSON.parse('{{compare_json}}' || '{}'); } catch(e) { data = {}; }
  const el = document.getElementById('compare-chart');
  if (!el || !Object.keys(data).length) {
    const section = el ? el.closest('section') : null;
    if (section) section.style.display = 'none';
    return;
  }
  const max = Math.max(...Object.values(data));
  el.innerHTML = Object.entries(data).map(([label, val]) => {
    const h = max ? Math.round((val / max) * 100) : 0;
    return `
      <div class="barv" style="--h: ${h}%">
        <div class="barv-fill"></div>
        <div class="barv-count">${val}</div>
        <div class="barv-label">${label}</div>
      </div>`;
  }).join('');
  requestAnimationFrame(() => { el.classList.add('animate'); });
})();
</script>
</body>
</html>
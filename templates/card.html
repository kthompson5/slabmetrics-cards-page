<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <script>document.documentElement.classList.add('js');</script>
  <title>{{player}} — {{set}} {{number}}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/styles.css?v=99" />
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a href="/index.html" class="brand">
        <img src="/logo.png" alt="SLABMETRICS" class="logo" />
        <span>SLABMETRICS</span>
      </a>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero reveal">
    <div class="container hero-inner">
      <!-- Title + meta -->
      <div class="hero-head">
        <h1 class="tight">
          <span class="dim">{{player}}</span>
          <span class="slash">—</span>
          {{set}} <span class="no-wrap">{{number}}</span>
        </h1>
        <p class="meta">
          <span class="meta-item"><strong>Serial:</strong> {{serial}}</span>
          <span class="dot">•</span>
          <span class="meta-item"><strong>Graded:</strong> {{graded_at}}</span>
          <span class="dot">•</span>
          <span class="meta-item"><strong>Team:</strong> {{team}}</span>
        </p>
      </div>

      <!-- Actions row (right side only: circle + slab badge) -->
      <div class="hero-actions">
        <div class="grade-side">
          <div class="overall" data-circle data-angle="{{overall_pct}}">
            <div class="circle" style="--angle:0%">
              <div class="circle-inner">{{overall_grade}}</div>
            </div>
            <div class="circle-label">SlabMetrics Score</div>
          </div>

          <!-- New slab badge: CSV grade + tier mapping -->
          <div class="slab-badge" data-slabbadge data-grade="{{overall_grade}}" aria-live="polite" aria-label="Grade label">
            <div class="slab-left">
              <div class="slab-tier" data-tier-name>—</div>
              <div class="slab-sub"  data-tier-sub></div>
            </div>
            <div class="slab-grade" data-tier-grade>—</div>
            </div>
<p class="slab-note">*Suggested industry standard grade.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Flip Viewer -->
  <section class="viewer">
    <div class="container">
      <div class="viewer-frame soft-frame">
        <div class="flip-wrap" data-cardflip title="Click or tap to flip (←/→ also)">
          <img class="flip-img front" src="{{front_img}}" alt="{{player}} front" loading="lazy" />
          <img class="flip-img back"  src="{{back_img}}"  alt="{{player}} back"  loading="lazy" />
        </div>
        <p class="hint">Tip: tap/click to flip • ← / → keys work too</p>
      </div>
    </div>
  </section>

  <!-- Downloads -->
  <section class="downloads">
    <div class="container">
      <div class="cta">
        <a class="btn btn-jpg" href="{{front_img}}" download="{{id}}-front.jpg" rel="noopener">Download Front (JPG)</a>
        <a class="btn btn-jpg" href="{{back_img}}"  download="{{id}}-back.jpg"  rel="noopener">Download Back (JPG)</a>
      </div>
    </div>
  </section>

  <!-- Subgrades -->
<section class="grades reveal">
  <div class="container grid-2">
    <!-- FRONT -->
    <div>
      <h2>Front Subgrades</h2>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Surface</div><div class="value">{{f_surface}}</div></div>
        <div class="bar"><span style="--pct: {{f_surface_pct}}%"></span></div>
      </div>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Centering</div><div class="value">{{f_centering}}</div></div>
        <div class="bar"><span style="--pct: {{f_centering_pct}}%"></span></div>
      </div>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Corners (avg)</div><div class="value">{{f_corners_avg}}</div></div>
        <div class="bar"><span style="--pct: {{f_corners_pct}}%"></span></div>
      </div>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Edges (avg)</div><div class="value">{{f_edges_avg}}</div></div>
        <div class="bar"><span style="--pct: {{f_edges_pct}}%"></span></div>
      </div>

      <div class="remarks">
        <div><strong>Surface:</strong> {{f_remarks_surface}}</div>
        <div><strong>Centering:</strong> {{f_remarks_centering}}</div>
        <div><strong>Corners:</strong> {{f_remarks_corners}}</div>
        <div><strong>Edges:</strong> {{f_remarks_edges}}</div>
      </div>
    </div>

    <!-- EDGE (now between Front and Back) -->
    <section class="edge-section edge-in-grid">
      <h2 class="edge-title">Centering Analysis</h2>
      <div class="edge-frame">
        <img src="{{edge_img}}" alt="EDGE centering report for {{player}}" loading="eager" />
      </div>
      <p class="edge-disclaimer">
        Estimates are based on EDGE centering ratios shown above. Final grades may vary by grader.
      </p>
    </section>

    <!-- BACK -->
    <div>
      <h2>Back Subgrades</h2>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Surface</div><div class="value">{{b_surface}}</div></div>
        <div class="bar"><span style="--pct: {{b_surface_pct}}%"></span></div>
      </div>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Centering</div><div class="value">{{b_centering}}</div></div>
        <div class="bar"><span style="--pct: {{b_centering_pct}}%"></span></div>
      </div>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Corners (avg)</div><div class="value">{{b_corners_avg}}</div></div>
        <div class="bar"><span style="--pct: {{b_corners_pct}}%"></span></div>
      </div>

      <div class="subgrade">
        <div class="subgrade-head"><div class="label">Edges (avg)</div><div class="value">{{b_edges_avg}}</div></div>
        <div class="bar"><span style="--pct: {{b_edges_pct}}%"></span></div>
      </div>

      <div class="remarks">
        <div><strong>Surface:</strong> {{b_remarks_surface}}</div>
        <div><strong>Centering:</strong> {{b_remarks_centering}}</div>
        <div><strong>Corners:</strong> {{b_remarks_corners}}</div>
        <div><strong>Edges:</strong> {{b_remarks_edges}}</div>
      </div>
    </div>
  </div>
</section>

  <!-- POP & GEM -->
  <section class="pop-gem reveal" id="popGem">
    <div class="container">
      <h2>Big 4 Pop & Gem Rate</h2>
      <p class="fine">
        <strong>Pop</strong> = how many of this card each company has graded.
        <strong>Gem Rate</strong> = share of those that earned the top grade
        (PSA/SGC/CGC = 10; <span class="bgs-note">BGS “gem” is 9.5</span>).
      </p>

      <!-- Pop bars -->
      <div class="pop-bars" data-popbars>
        <div class="pop-row" data-co="psa" data-pop="{{psa_pop}}">
          <div class="co"><span class="dot psa"></span>PSA</div>
          <div class="bar"><span></span></div>
          <div class="val" data-out>—</div>
        </div>

        <div class="pop-row" data-co="sgc" data-pop="{{sgc_pop}}">
          <div class="co"><span class="dot sgc"></span>SGC</div>
          <div class="bar"><span></span></div>
          <div class="val" data-out>—</div>
        </div>

        <div class="pop-row" data-co="cgc" data-pop="{{cgc_pop}}">
          <div class="co"><span class="dot cgc"></span>CGC</div>
          <div class="bar"><span></span></div>
          <div class="val" data-out>—</div>
        </div>

        <div class="pop-row" data-co="bgs" data-pop="{{bgs_pop}}">
          <div class="co"><span class="dot bgs"></span>Beckett</div>
          <div class="bar"><span></span></div>
          <div class="val" data-out>—</div>
        </div>
      </div>

      <!-- Gem rings -->
      <div class="gem-grid" data-gemrings>
        <div class="gem" data-co="psa" data-rate="{{psa_gem_rate}}">
          <div class="gem-ring" style="--angle:0%">
            <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
          </div>
          <div class="gem-label"><span class="dot psa"></span>PSA Gem Rate</div>
        </div>

        <div class="gem" data-co="sgc" data-rate="{{sgc_gem_rate}}">
          <div class="gem-ring" style="--angle:0%">
            <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
          </div>
          <div class="gem-label"><span class="dot sgc"></span>SGC Gem Rate</div>
        </div>

        <div class="gem" data-co="cgc" data-rate="{{cgc_gem_rate}}">
          <div class="gem-ring" style="--angle:0%">
            <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
          </div>
          <div class="gem-label"><span class="dot cgc"></span>CGC Gem Rate</div>
        </div>

        <div class="gem" data-co="bgs" data-rate="{{bgs_gem_rate}}">
          <div class="gem-ring" style="--angle:0%">
            <div class="gem-kpi"><span class="num" data-rate-out>0%</span></div>
          </div>
          <div class="gem-label"><span class="dot bgs"></span>BGS Gem Rate</div>
        </div>
      </div>

      <p class="fine small-note">
        Pop figures are a snapshot <strong>as of {{graded_at}}</strong>.
        “Gem” means the top grade (PSA/SGC/CGC = 10; <strong>BGS = 9.5</strong>).
      </p>
    </div>
  </section>

  <footer class="site-footer">
    <div class="container">
      <div class="footer-buttons">
        <a class="btn btn-green" href="{{ebay}}" target="_blank" rel="noopener">View eBay Comps</a>
        <a class="btn" href="/index.html">← Back to All Cards</a>
      </div>
    </div>
  </footer>

  <!-- ===== Consolidated, fault-tolerant JS ===== -->
  <script>
  /* 0) Utility: conic fill */
  function animateCircleAngle(el, targetPct, duration = 900){
    try{
      if (!el) return;
      const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
      const startPct = parseFloat(getComputedStyle(el).getPropertyValue('--angle')) || 0;
      const endPct = Math.max(0, Math.min(100, targetPct));
      if (reduce) { el.style.setProperty('--angle', endPct + '%'); return; }
      const start = performance.now(), ease = t => 1 - Math.pow(1 - t, 3);
      (function frame(now){
        const t = Math.min(1, (now - start) / duration);
        const v = startPct + (endPct - startPct) * ease(t);
        el.style.setProperty('--angle', v.toFixed(2) + '%');
        if (t < 1) requestAnimationFrame(frame);
      })(start);
    }catch(e){ console.error('animateCircleAngle', e); }
  }

  /* 1) Flip */
  (function(){
    try{
      const root = document.querySelector('[data-cardflip]');
      if (!root) return;
      let flipped = false, startX = null;
      const setFlipped = v => { flipped=v; root.classList.toggle('flipped', flipped); };
      root.addEventListener('click', () => setFlipped(!flipped));
      root.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, {passive:true});
      root.addEventListener('touchend', e => {
        if (startX==null) return;
        const dx = e.changedTouches[0].clientX - startX;
        if (Math.abs(dx) > 40) setFlipped(dx < 0);
        startX = null;
      }, {passive:true});
      root.tabIndex = 0;
      root.addEventListener('keydown', (e) => {
        if (e.key==='Enter'||e.key===' ') { e.preventDefault(); setFlipped(!flipped); }
        if (e.key==='ArrowLeft') setFlipped(true);
        if (e.key==='ArrowRight') setFlipped(false);
      });
    }catch(e){ console.error('flip', e); }
  })();

  /* 2) Reveal + bars + overall circle */
  (function(){
    try{
      const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
      const reveals = document.querySelectorAll('.reveal');

      if (!('IntersectionObserver' in window)){
        reveals.forEach(el => el.classList.add('is-visible'));
      } else {
        const io = new IntersectionObserver((entries) => {
          entries.forEach((e) => {
            if (!e.isIntersecting) return;
            e.target.classList.add('is-visible');

            const box = e.target.querySelector?.('[data-circle]');
            const circ = box?.querySelector?.('.circle');
            if (!reduce && box && circ) {
              const raw = Number(box.dataset.angle || 0);
              const angle = raw <= 1 ? raw * 100 : raw;
              animateCircleAngle(circ, angle, 900);
            }
          });
        }, { threshold: 0.2 });
        reveals.forEach(el => io.observe(el));
      }

      // subgrade bars
      document.querySelectorAll('.bar > span').forEach(s => {
        const m = (s.getAttribute('style') || '').match(/--pct:\s*([\d.]+)%/);
        const pct = m ? m[1] : '0';
        s.style.width = reduce ? pct + '%' : '0%';
        if (!reduce) requestAnimationFrame(() => { s.style.width = pct + '%'; });
      });
    }catch(e){ console.error('reveal & bars', e); }
  })();

  /* 3) Ensure overall circle fill on reduced motion */
  (function(){
    try{
      const box = document.querySelector('[data-circle]');
      const circ = box?.querySelector?.('.circle');
      if (!box || !circ) return;
      const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
      const raw = Number(box.dataset.angle || 0);
      const pct = raw <= 1 ? raw * 100 : raw;
      if (reduce) circ.style.setProperty('--angle', pct + '%');
    }catch(e){ console.error('overall reduced motion', e); }
  })();

/* 4) Slab badge (reads CSV overall grade via data-grade) */
(function(){
  try {
    const badge = document.querySelector('[data-slabbadge]');
    if (!badge) return;

    // pull from CSV attribute or fallback to circle text
    const csvVal    = parseFloat((badge.getAttribute('data-grade') || '').replace(/[^\d.]/g,''));
    const circleVal = parseFloat((document.querySelector('.circle-inner')?.textContent || '').replace(/[^\d.]/g,''));
    const grade     = (isFinite(csvVal) ? csvVal : circleVal);
    if (!isFinite(grade)) return;

    // binning function: converts raw grade → 10, 9.5, 9, etc.
    function binVal(v){
      if (v >= 9.75) return 10.0;
      if (v >= 9.25) return 9.5;
      if (v >= 8.75) return 9.0;
      if (v >= 8.25) return 8.5;
      if (v >= 7.50) return 8.0;
      if (v >= 6.50) return 7.0;
      if (v >= 5.50) return 6.0;
      if (v >= 4.50) return 5.0;
      if (v >= 3.50) return 4.0;
      if (v >= 2.50) return 3.0;
      if (v >= 1.50) return 2.0;
      return 1.0;
    }

    const NAMES = {
      10.0: { tier:'APEX',      sub:'GEM MINT', base:'10'  },
      9.5:  { tier:'ELITE',     sub:'MINT+',    base:'9.5' },
      9.0:  { tier:'MINT',      sub:'',         base:'9'   },
      8.5:  { tier:'STRONG',    sub:'',         base:'8.5' },
      8.0:  { tier:'SOLID',     sub:'NM-MT',    base:'8'   },
      7.0:  { tier:'COLLECTOR', sub:'NM',       base:'7'   },
      6.0:  { tier:'PLAYABLE',  sub:'EX-MT',    base:'6'   },
      5.0:  { tier:'CLASSIC',   sub:'EX',       base:'5'   },
      4.0:  { tier:'VINTAGE',   sub:'VG-EX',    base:'4'   },
      3.0:  { tier:'WORN',      sub:'VG',       base:'3'   },
      2.0:  { tier:'POOR+',     sub:'',         base:'2'   },
      1.0:  { tier:'POOR',      sub:'',         base:'1'   },
    };

    const bin  = binVal(grade);
    const meta = NAMES[bin] || { tier:'—', sub:'', base:'—' };

    // write into badge slots
    const nameEl = badge.querySelector('[data-tier-name]');
    const subEl  = badge.querySelector('[data-tier-sub]');
    const numEl  = badge.querySelector('[data-tier-grade]');
    if (nameEl) nameEl.textContent = meta.tier;
    if (subEl)  subEl.textContent  = meta.sub || '';

    // ✅ now shows the binned "equivalent" instead of raw decimal
    if (numEl)  numEl.textContent  = meta.base;

  } catch(e){ 
    console.error('slab badge', e); 
  }
})();

  /* 5) Pop & Gem */
  (function(){
    try{
      const section = document.getElementById('popGem');
      if (!section) return;

      const toNum = (v) => {
        if (v == null) return 0;
        const s = String(v).trim().replace(/[^0-9.]/g, '');
        const n = parseFloat(s);
        return isFinite(n) ? n : 0;
      };

      function go(){
        // Pop bars
        const rows = Array.from(section.querySelectorAll('[data-popbars] .pop-row'));
        const pops = rows.map(r => Math.max(0, toNum(r.dataset.pop)));
        const max = Math.max(...pops, 0);

        rows.forEach((r, i) => {
          const val = pops[i] || 0;
          const out = r.querySelector('[data-out]');
          const fill = r.querySelector('.bar > span');
          if (out) out.textContent = val ? val.toLocaleString() : '0';
          const pct = max ? (val / max) * 100 : 0;
          const reduce = matchMedia('(prefers-reduced-motion: reduce)').matches;
          if (fill){
            if (reduce) fill.style.width = pct + '%';
            else requestAnimationFrame(() => { fill.style.width = pct + '%'; });
          }
        });

        // Gem rings
        section.querySelectorAll('[data-gemrings] .gem').forEach(card => {
          const rate = Math.max(0, Math.min(100, toNum(card.dataset.rate)));
          const ring = card.querySelector('.gem-ring');
          const label = card.querySelector('[data-rate-out]');
          if (ring) animateCircleAngle(ring, rate, 900);
          if (label) label.textContent = Math.round(rate) + '%';
        });
      }

      // Run on reveal or immediately
      if ('IntersectionObserver' in window){
        const io = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting){ go(); io.disconnect(); } });
        }, { threshold: 0.2 });
        io.observe(section);
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', go, { once:true });
      } else {
        setTimeout(go, 0);
      }
    }catch(e){ console.error('pop & gem', e); }
  })();
  </script>
</body>
</html>